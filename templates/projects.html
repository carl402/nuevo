{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="text-primary"><i class="fas fa-folder me-2"></i>Proyectos</h2>
</div>

<form class="row g-3 mb-3" method="get" action="{{ url_for('projects_list') }}">
  <div class="col-auto">
    <input name="q" value="{{ q or '' }}" class="form-control" placeholder="Buscar por nombre">
  </div>
  <div class="col-auto">
    <button class="btn btn-primary">Buscar</button>
  </div>
</form>

<div class="card mb-3">
  <div class="card-body">
    <h5>Crear Proyecto</h5>
    <form method="post" action="{{ url_for('projects_create') }}">
      <div class="mb-2">
        <input name="name" placeholder="Nombre" class="form-control" required />
      </div>
      <div class="mb-2">
        <input name="description" placeholder="Descripción" class="form-control" />
      </div>

      <button class="btn btn-success">Crear Proyecto</button>
    </form>
  </div>
</div>

<table class="table">
  <thead>
    <tr><th>Nombre</th><th>Descripción</th><th>Fecha</th><th>Variables</th><th>Acciones</th></tr>
  </thead>
  <tbody>
    {% for p in projects %}
      <tr>
        <td>{{ p.name }}</td>
        <td>{{ p.description }}</td>
        <td>{{ p.created_at.strftime('%Y-%m-%d') if p.created_at else 'N/A' }}</td>
        <td>{{ p.variables|length }}</td>
        <td>
          <form method="post" action="{{ url_for('projects_delete', project_id=p.id) }}" style="display:inline">
            <button class="btn btn-sm btn-danger">Eliminar</button>
          </form>
          <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#configModal{{ p.id }}">Configurar</button>
          <form method="post" action="{{ url_for('project_simulate', project_id=p.id) }}" style="display:inline">
            <input type="hidden" name="iterations" value="1000">
            <button class="btn btn-sm btn-outline-success">Ejecutar</button>
          </form>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Modales de configuración -->
{% for p in projects %}
<div class="modal fade" id="configModal{{ p.id }}">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5>Configurar {{ p.name }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <h6>Variables ({{ p.variables|length }})</h6>
        {% for v in p.variables %}
          <div class="alert alert-info">{{ v.name }} - {{ v.distribution|title }}</div>
        {% endfor %}
        
        <h6>Agregar Variable</h6>
        <form id="varForm{{ p.id }}" onsubmit="addVariable(event, '{{ p.id }}'); return false;">
          <div class="row mb-2">
            <div class="col-6"><input name="var_name" placeholder="Nombre" class="form-control" required></div>
            <div class="col-6">
              <select name="var_dist" class="form-select" onchange="showParams(this, '{{ p.id }}')">
                <option value="normal">Normal</option>
                <option value="uniform">Uniforme</option>
                <option value="triangular">Triangular</option>
              </select>
            </div>
          </div>
          <div id="params{{ p.id }}">
            <div class="row mb-2">
              <div class="col-6"><input name="mean" placeholder="Media" class="form-control" value="50"></div>
              <div class="col-6"><input name="std" placeholder="Desv. Est." class="form-control" value="15"></div>
            </div>
          </div>
          <button type="submit" class="btn btn-success">Agregar Variable</button>
        </form>
        <div id="variables{{ p.id }}">
          {% for v in p.variables %}
            <div class="alert alert-info">{{ v.name }} - {{ v.distribution|title }}</div>
          {% endfor %}
        </div>
        
        <hr>
        <h6>Ejecutar Simulación</h6>
        <form method="post" action="{{ url_for('project_simulate', project_id=p.id) }}">
          <div class="row mb-2">
            <div class="col-6"><input name="iterations" placeholder="Iteraciones" class="form-control" value="1000"></div>
            <div class="col-6"><input name="seed" placeholder="Semilla (opcional)" class="form-control"></div>
          </div>
          <button class="btn btn-success">Ejecutar Simulación</button>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
{% endfor %}

<script>
function showParams(select, projectId) {
  var params = document.getElementById('params' + projectId);
  var dist = select.value;
  if (dist === 'normal') {
    params.innerHTML = '<div class="row mb-2"><div class="col-6"><input name="mean" placeholder="Media" class="form-control" value="50"></div><div class="col-6"><input name="std" placeholder="Desv. Est." class="form-control" value="15"></div></div>';
  } else if (dist === 'uniform') {
    params.innerHTML = '<div class="row mb-2"><div class="col-6"><input name="low" placeholder="Mínimo" class="form-control" value="0"></div><div class="col-6"><input name="high" placeholder="Máximo" class="form-control" value="100"></div></div>';
  } else if (dist === 'triangular') {
    params.innerHTML = '<div class="row mb-2"><div class="col-4"><input name="left" placeholder="Mínimo" class="form-control" value="10"></div><div class="col-4"><input name="mode" placeholder="Moda" class="form-control" value="50"></div><div class="col-4"><input name="right" placeholder="Máximo" class="form-control" value="90"></div></div>';
  }
}

// Función para agregar variable sin cerrar modal
function addVariable(event, projectId) {
  event.preventDefault();
  var form = event.target;
  var formData = new FormData(form);
  
  fetch('/projects/' + projectId + '/variables/add', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Agregar variable a la lista
      var variablesDiv = document.getElementById('variables' + projectId);
      var newVar = document.createElement('div');
      newVar.className = 'alert alert-info';
      newVar.textContent = data.variable.name + ' - ' + data.variable.distribution;
      variablesDiv.appendChild(newVar);
      
      // Limpiar formulario
      form.reset();
      showParams(form.querySelector('select'), projectId);
      
      // Actualizar contador en tabla
      location.reload();
    } else {
      alert('Error: ' + data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error al agregar variable');
  });
}

// Auto-abrir modal si se creó un proyecto
var urlParams = new URLSearchParams(window.location.search);
var openConfig = urlParams.get('open_config');
if (openConfig) {
  var modal = new bootstrap.Modal(document.getElementById('configModal' + openConfig));
  modal.show();
  // Limpiar URL
  window.history.replaceState({}, document.title, window.location.pathname);
}
</script>

{% endblock %}
